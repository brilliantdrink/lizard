<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lizard Button</title>
    <style>
      body {
        margin: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;

        height: 100vh;
        box-sizing: border-box;
        padding-bottom: 10vh;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        font-size: 1.5rem;

        background: #222;
        color: #fff;
      }

      #background, #background-underlay {
        position: fixed;
        top: 0;
        left: 0;
        height: 10000vh;
        width: 10000vw;
        transform-origin: top left;
        transform: scale(.01);

        font-size: 1vw;
        opacity: 0.2;
        z-index: -10;
        pointer-events: none;
      }

      #personal-counter, #global-counter {
        position: fixed;
        top: 1rem;
        left: 1rem;
      }

      #global-counter {
        left: initial;
        right: 1rem;
      }

      #lizard-video {
        width: 30vh;
        height: 30vh;
      }

      #big-button {
        width: 30vh;
        height: 30vh;
        border-radius: 50%;
        border: 1px solid #444;
        background: radial-gradient(farthest-corner at 20% 20%, #222, #292929, #2b2b2b);
        box-shadow: 0 0 5vh #111;
        font-size: 10vh;
        touch-action: manipulation;
        user-select: none;
      }

      #big-button:active {
        box-shadow: 0 0 2vh #111;
        transform: scale(0.99);
      }
    </style>
</head>
<body>
<div id="background"></div>
<span id="personal-counter">Counter:&nbsp;<span class="count">0</span></span>
<span id="global-counter">Global counter:&nbsp;<span class="count">0</span></span>
<video id="lizard-video" src="lizard.webm" playsinline muted></video>
<button id="big-button">&#129422;</button>
<script>
  function supportsHEVCAlpha() {
    const navigator = window.navigator;
    const ua = navigator.userAgent.toLowerCase()
    const hasMediaCapabilities = !!(navigator.mediaCapabilities && navigator.mediaCapabilities.decodingInfo)
    const isSafari = ua.includes('safari') && !ua.includes('chrome') && ua.includes('version/')
    return isSafari && hasMediaCapabilities
  }

  const filledBackground = 16000

  const button = document.getElementById('big-button');
  const video = document.getElementById('lizard-video');
  const background = document.getElementById('background');
  const backgroundUnderlay = document.createElement('div');
  backgroundUnderlay.id = 'background-underlay';
  backgroundUnderlay.innerHTML = Array(filledBackground).fill('&#129422;').join('');
  let backgroundUnderlayAppended = false
  const counter = document.querySelector('#global-counter .count');
  const personalCounter = document.querySelector('#personal-counter .count');

  const updateBgFontSize = () => {
    const size = Math.sqrt(window.innerWidth * window.innerHeight) * .7 + 'px'
    background.style.fontSize = size;
    backgroundUnderlay.style.fontSize = size;
  }
  window.addEventListener('resize', updateBgFontSize);
  updateBgFontSize()

  if (supportsHEVCAlpha()) {
    video.src = 'lizard.mov'
    video.play()
    setTimeout(() => video.pause())
  }

  const ws = new WebSocket('wss://api.b-dr.ink/lizard/')
  ws.addEventListener("message", (event) => {
    clickCount = event.data || 0;
    counter.textContent = clickCount
  })

  let clickCount = 0;
  let personalClickCount = 0;

  const audioPool = [];
  const poolSize = 5;
  let currentAudioIndex = 0;
  let audioBuffer = null;
  let audioContext = null;

  const saved = localStorage.getItem('personalClickCount');
  personalClickCount = saved ? parseInt(saved, 10) : 0;
  updateCountRender(personalClickCount)

  function updateCountRender(count) {
    personalCounter.textContent = count;
    if (!backgroundUnderlayAppended && count > filledBackground) {
      backgroundUnderlayAppended = true
      document.body.append(backgroundUnderlay)
      background.style.opacity = "0.1"
    }
    backgroundUnderlay.style.opacity = String(0.2 + ((Math.floor(count / filledBackground) - 1) / 10))
    background.innerHTML = Array(count % filledBackground).fill('&#129422;').join('');
  }

  function initializeAudioContext() {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioContext;
  }

  async function loadAudioBuffer() {
    if (audioBuffer) return audioBuffer;

    try {
      const audioCtx = initializeAudioContext();
      const response = await fetch('lizard.wav');
      const arrayBuffer = await response.arrayBuffer();
      audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      return audioBuffer;
    } catch (error) {
      console.log('Failed to load audio buffer, falling back to HTML Audio:', error);
      return null;
    }
  }

  for (let i = 0; i < poolSize; i++) {
    const audio = new Audio('lizard.wav');
    audio.preload = 'auto';
    audio.volume = 1.0;
    audioPool.push(audio);
  }

  try {
    loadAudioBuffer().then(() => audioPool.forEach(audio => audio.load()))
  } catch (error) {
    console.log('Web Audio initialization failed, using HTML Audio fallback');
  }

  async function lizard() {
    video.currentTime = 0;
    video.play();

    if (audioBuffer && audioContext) {
      try {
        const audioCtx = audioContext;
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        const source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioCtx.destination);
        source.start(0);
        return;
      } catch (error) {
        console.log('Web Audio API failed, falling back to HTML Audio:', error);
      }
    }

    const audio = audioPool[currentAudioIndex];

    if (!audio.paused) audio.pause();
    audio.currentTime = 0;

    try {
      await audio.play();
    } catch (error) {
      currentAudioIndex = (currentAudioIndex + 1) % poolSize;
    }

    currentAudioIndex = (currentAudioIndex + 1) % poolSize;
  }

  button.addEventListener('click', () => {
    lizard();

    clickCount++;
    counter.textContent = clickCount

    personalClickCount++;
    updateCountRender(personalClickCount);
    localStorage.setItem('personalClickCount', personalClickCount.toString());
    ws.send("1")
  });

</script>
</body>
</html>
